<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Python</title>
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/styles/github-gist.css">
    <script src="/assets/js/toc.js"></script>
    <script src="/assets/js/highlight.pack.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true
        }
      });
    </script>

    <script type="text/javascript" id="MathJax-script" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"
      >
    </script>
    
    </head>

  <body>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <nav>
    <ul>
        
        <li>
        <a href=/
            
        >
            Home
        </a>
        </li>
        
        <li>
        <a href=/notebook_en.html
            
        >
            Notebook
        </a>
        </li>
        
        <li>
        <a href=/notebook_cn.html
            
        >
            笔记本
        </a>
        </li>
        
    </ul>
</nav>


    <div class="main">
        <div id="side_bar">
    22 Oct 2020
</div>

<div class="center post">
    <ul id="markdown-toc">
  <li><a href="#sphinx" id="markdown-toc-sphinx">Sphinx</a>    <ul>
      <li><a href="#使用流程" id="markdown-toc-使用流程">使用流程</a></li>
      <li><a href="#有用的扩展" id="markdown-toc-有用的扩展">有用的扩展</a></li>
      <li><a href="#在网页中渲染代码块" id="markdown-toc-在网页中渲染代码块">在网页中渲染代码块</a></li>
      <li><a href="#在网页中渲染公式" id="markdown-toc-在网页中渲染公式">在网页中渲染公式</a></li>
      <li><a href="#加入链接到-python-文档" id="markdown-toc-加入链接到-python-文档">加入链接到 Python 文档</a></li>
    </ul>
  </li>
  <li><a href="#pybind11" id="markdown-toc-pybind11">PyBind11</a>    <ul>
      <li><a href="#为什么用-pybindr11" id="markdown-toc-为什么用-pybindr11">为什么用 pybindr11</a></li>
      <li><a href="#安装-pybind11-和-eigen" id="markdown-toc-安装-pybind11-和-eigen">安装 pybind11 和 eigen</a></li>
      <li><a href="#使用-pybind11" id="markdown-toc-使用-pybind11">使用 pybind11</a></li>
      <li><a href="#使用-numpy" id="markdown-toc-使用-numpy">使用 numpy</a></li>
      <li><a href="#使用-eigen" id="markdown-toc-使用-eigen">使用 eigen</a></li>
    </ul>
  </li>
  <li><a href="#元编程" id="markdown-toc-元编程">元编程</a>    <ul>
      <li><a href="#概念" id="markdown-toc-概念">概念</a></li>
      <li><a href="#新式类和旧式类" id="markdown-toc-新式类和旧式类">新式类和旧式类</a></li>
      <li><a href="#元类类的类" id="markdown-toc-元类类的类">元类：类的类</a></li>
      <li><a href="#作用动态定义类" id="markdown-toc-作用动态定义类">作用：动态定义类</a></li>
      <li><a href="#自定义元类" id="markdown-toc-自定义元类">自定义元类</a></li>
      <li><a href="#修改-type" id="markdown-toc-修改-type">修改 type</a></li>
      <li><a href="#自定义元类-1" id="markdown-toc-自定义元类-1">自定义元类</a></li>
      <li><a href="#避免使用元类" id="markdown-toc-避免使用元类">避免使用元类</a></li>
    </ul>
  </li>
  <li><a href="#常用内置函数" id="markdown-toc-常用内置函数">常用内置函数</a>    <ul>
      <li><a href="#enumerate" id="markdown-toc-enumerate">enumerate()</a></li>
      <li><a href="#zip" id="markdown-toc-zip">zip()</a></li>
      <li><a href="#filter" id="markdown-toc-filter">filter()</a></li>
      <li><a href="#reduce" id="markdown-toc-reduce">reduce()</a></li>
    </ul>
  </li>
  <li><a href="#动态类型" id="markdown-toc-动态类型">动态类型</a>    <ul>
      <li><a href="#概念-1" id="markdown-toc-概念-1">概念</a></li>
      <li><a href="#引用示例" id="markdown-toc-引用示例">引用示例</a></li>
      <li><a href="#列表引用" id="markdown-toc-列表引用">列表引用</a></li>
      <li><a href="#参数传递与动态类型" id="markdown-toc-参数传递与动态类型">参数传递与动态类型</a></li>
    </ul>
  </li>
  <li><a href="#上下文管理器" id="markdown-toc-上下文管理器">上下文管理器</a>    <ul>
      <li><a href="#工作原理" id="markdown-toc-工作原理">工作原理</a></li>
      <li><a href="#自定义上下文管理器" id="markdown-toc-自定义上下文管理器">自定义上下文管理器</a></li>
    </ul>
  </li>
  <li><a href="#闭包" id="markdown-toc-闭包">闭包</a>    <ul>
      <li><a href="#函数对象的作用域" id="markdown-toc-函数对象的作用域">函数对象的作用域</a></li>
      <li><a href="#闭包的实现" id="markdown-toc-闭包的实现">闭包的实现</a></li>
    </ul>
  </li>
  <li><a href="#装饰器" id="markdown-toc-装饰器">装饰器</a>    <ul>
      <li><a href="#基本装饰器" id="markdown-toc-基本装饰器">基本装饰器</a></li>
      <li><a href="#参数化的装饰器" id="markdown-toc-参数化的装饰器">参数化的装饰器</a></li>
      <li><a href="#装饰类" id="markdown-toc-装饰类">装饰类</a></li>
      <li><a href="#日志记录" id="markdown-toc-日志记录">日志记录</a></li>
    </ul>
  </li>
  <li><a href="#内存管理" id="markdown-toc-内存管理">内存管理</a>    <ul>
      <li><a href="#对象的内存使用" id="markdown-toc-对象的内存使用">对象的内存使用</a></li>
      <li><a href="#引用计数" id="markdown-toc-引用计数">引用计数</a></li>
      <li><a href="#容器中的引用" id="markdown-toc-容器中的引用">容器中的引用</a></li>
      <li><a href="#引用环" id="markdown-toc-引用环">引用环</a></li>
      <li><a href="#减少引用" id="markdown-toc-减少引用">减少引用</a></li>
      <li><a href="#垃圾回收" id="markdown-toc-垃圾回收">垃圾回收</a></li>
      <li><a href="#分代回收" id="markdown-toc-分代回收">分代回收</a></li>
      <li><a href="#回收孤立的引用环" id="markdown-toc-回收孤立的引用环">回收孤立的引用环</a></li>
    </ul>
  </li>
  <li><a href="#os-标准库" id="markdown-toc-os-标准库">OS 标准库</a>    <ul>
      <li><a href="#ospath" id="markdown-toc-ospath">os.path</a></li>
      <li><a href="#进程信息" id="markdown-toc-进程信息">进程信息</a></li>
      <li><a href="#其他方法" id="markdown-toc-其他方法">其他方法</a></li>
    </ul>
  </li>
  <li><a href="#pickle" id="markdown-toc-pickle">Pickle</a></li>
  <li><a href="#subprocess" id="markdown-toc-subprocess">Subprocess</a>    <ul>
      <li><a href="#常用功能" id="markdown-toc-常用功能">常用功能</a></li>
      <li><a href="#popen" id="markdown-toc-popen">Popen()</a></li>
      <li><a href="#文本流控制" id="markdown-toc-文本流控制">文本流控制</a></li>
    </ul>
  </li>
  <li><a href="#循环器" id="markdown-toc-循环器">循环器</a>    <ul>
      <li><a href="#无穷循环器" id="markdown-toc-无穷循环器">无穷循环器</a></li>
      <li><a href="#函数式工具" id="markdown-toc-函数式工具">函数式工具</a></li>
      <li><a href="#组合工具" id="markdown-toc-组合工具">组合工具</a></li>
      <li><a href="#groupby" id="markdown-toc-groupby">groupby()</a></li>
    </ul>
  </li>
  <li><a href="#sqlite3" id="markdown-toc-sqlite3">Sqlite3</a>    <ul>
      <li><a href="#创建数据库" id="markdown-toc-创建数据库">创建数据库</a></li>
      <li><a href="#插入数据" id="markdown-toc-插入数据">插入数据</a></li>
      <li><a href="#选择数据" id="markdown-toc-选择数据">选择数据</a></li>
      <li><a href="#更新和删除数据" id="markdown-toc-更新和删除数据">更新和删除数据</a></li>
      <li><a href="#查看所有表和删除表" id="markdown-toc-查看所有表和删除表">查看所有表和删除表</a></li>
    </ul>
  </li>
  <li><a href="#网络" id="markdown-toc-网络">网络</a>    <ul>
      <li><a href="#tcpip-和-socket" id="markdown-toc-tcpip-和-socket">TCP/IP 和 socket</a></li>
      <li><a href="#socket-服务器" id="markdown-toc-socket-服务器">Socket 服务器</a></li>
      <li><a href="#http-服务器" id="markdown-toc-http-服务器">HTTP 服务器</a>        <ul>
          <li><a href="#示例" id="markdown-toc-示例">示例</a></li>
          <li><a href="#使用-socketserver" id="markdown-toc-使用-socketserver">使用 socketserver</a></li>
        </ul>
      </li>
      <li><a href="#httpserver" id="markdown-toc-httpserver">http.server</a>        <ul>
          <li><a href="#simplehttprequesthandler" id="markdown-toc-simplehttprequesthandler">SimpleHTTPRequestHandler</a></li>
          <li><a href="#cgihttpserver" id="markdown-toc-cgihttpserver">CGIHTTPServer</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="sphinx">Sphinx</h2>

<p>我最近使用 <code class="language-plaintext highlighter-rouge">Sphinx</code> 把我的<a href="https://github.com/yangyushi/FishPy">博士期间的代码</a>的文档构建了出来。我十分喜欢<a href="https://yangyushi.github.io/FishPy/">得到的结果</a>。使用 <code class="language-plaintext highlighter-rouge">Sphinx</code> 构建文档的过程同 <code class="language-plaintext highlighter-rouge">Jekyll</code> 的使用类似，都是从文本中读取信息，然后在渲染到 HTML 网页中。</p>

<h3 id="使用流程">使用流程</h3>

<ol>
  <li>无论使用什么语言，好好写 <code class="language-plaintext highlighter-rouge">docstring</code></li>
  <li>用 <code class="language-plaintext highlighter-rouge">sphinx-quickstart</code> 生成一堆东西</li>
  <li>修改 <code class="language-plaintext highlighter-rouge">conf.py</code></li>
  <li>使用 <code class="language-plaintext highlighter-rouge">sphinx-apidoc 模块地址 -o rst导出地址</code> 生成每个 package 的 rst 文档</li>
  <li>把 <code class="language-plaintext highlighter-rouge">modules</code> 加入到 <code class="language-plaintext highlighter-rouge">index.rst</code></li>
</ol>

<h3 id="有用的扩展">有用的扩展</h3>

<p>在 Sphinx 中，我们需要 增加一些 扩展 Extension 才能让 Sphinx 变得有用。我个人使用的 Extension 如下，</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">'</span><span class="s">sphinx.ext.autodoc</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">sphinx.ext.napoleon</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">sphinx.ext.intersphinx</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">sphinx.ext.mathjax</span><span class="sh">'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div>

<p>其中，每个扩展的作用 分别是</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">autodoc</code>: 配合 <code class="language-plaintext highlighter-rouge">sphinx-apidoc</code> 自动生成所有 package 下「每个模块」的 文档。</li>
  <li><code class="language-plaintext highlighter-rouge">napoleon</code>: 让 Sphinx 能够 理解 Google 风格的 docstring。</li>
  <li><code class="language-plaintext highlighter-rouge">intersphinx</code>: 让 Sphinx 能够自动给文档里的 类、函数 添加链接</li>
  <li><code class="language-plaintext highlighter-rouge">mathjax</code>: 配合 <code class="language-plaintext highlighter-rouge">:math:</code> 和 <code class="language-plaintext highlighter-rouge">.. math::</code> 在文档里渲染 $\LaTeX$ 公式</li>
</ol>

<h3 id="在网页中渲染代码块">在网页中渲染代码块</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.. code-block::

    your code
</code></pre></div></div>

<h3 id="在网页中渲染公式">在网页中渲染公式</h3>

<p>把这个 2020 年还 work 的 CDN 添加到 <code class="language-plaintext highlighter-rouge">conf.py</code></p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mathjax_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML</span><span class="sh">"</span>
</code></pre></div></div>

<p>使用下面代码渲染 单独的 公式</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.. math::

    \LaTeX code
</code></pre></div></div>

<p>使用 <code class="language-plaintext highlighter-rouge">:math:</code><code class="language-plaintext highlighter-rouge">latex</code></p>

<h3 id="加入链接到-python-文档">加入链接到 Python 文档</h3>

<p>普通情况下，我们用 sphinx 写 python 的 docstring 时，我们写出下面的代码</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Foo
    
    Args:
        a (int): ...
    </span><span class="sh">"""</span>
    <span class="bp">...</span>
</code></pre></div></div>

<p>这个时候，类型 <code class="language-plaintext highlighter-rouge">int</code> 能够配合 <code class="language-plaintext highlighter-rouge">intersphinx</code> 产生一个链接到 python 文档的链接。但是字体是普通的斜体。如果我们写出下面的代码</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Foo
    
    Args:
        a (:obj: `int`): ...
    </span><span class="sh">"""</span>
    <span class="bp">...</span>
</code></pre></div></div>

<p>生成的链接就会是非衬线体，好看一点。</p>

<h2 id="pybind11">PyBind11</h2>

<p><a href="http://people.duke.edu/~ccc14/cspy/18G_C++_Python_pybind11.html">参考资料</a></p>

<p>Python 中速度慢的代码可以在 C++ 中重写，并且被直接引用到 Python 里。这样通常可以让代码的速度提高一个数量级。
使用 <code class="language-plaintext highlighter-rouge">pybind11</code> ，我们可以将 C++ 代码转化成一个 Python 模块。</p>

<h3 id="为什么用-pybindr11">为什么用 pybindr11</h3>

<p>我想要使用 C++ 来加速我的代码里慢的部分。理想状态下，我希望把我手头现有的「所有」Python 代码都写成对应的 C++ 版本，然后在 Python 脚本里使用 C++ 版本的 wrapper。</p>

<p>同时，我希望保留下最初的 Python 版本。比如，如果我有一个叫做 <code class="language-plaintext highlighter-rouge">correlation.py</code> 模块，模块里有一些类和函数，我希望编写一个 <code class="language-plaintext highlighter-rouge">c_correlation.cpp</code> 的 wrapper，暴露「相同」的 api 给用户。</p>

<p>在 <code class="language-plaintext highlighter-rouge">import</code> 的时候，我希望达到这样的效果</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">c_correlation</span> <span class="k">as</span> <span class="n">corr</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">correlation</span> <span class="k">as</span> <span class="n">corr</span>
</code></pre></div></div>

<p>在我的 <code class="language-plaintext highlighter-rouge">c_corrlation.cpp</code> 文件里，我最需要完成的是 Pyhton 和 C++ 数据类型的转换。十分幸运的是，<code class="language-plaintext highlighter-rouge">pybind11</code> 可以自动地帮助我将 <code class="language-plaintext highlighter-rouge">List</code>, <code class="language-plaintext highlighter-rouge">Dict</code> 和 <code class="language-plaintext highlighter-rouge">numpy.ndarray</code> 转换成相应的 C++ 数据结构。</p>

<p>我认为这个也是大家使用 <code class="language-plaintext highlighter-rouge">pybind11</code> 的意义；否则的话我们总是可以直接用 C 语言扩展 CPython 代码。</p>

<h3 id="安装-pybind11-和-eigen">安装 pybind11 和 eigen</h3>

<p>pybinder11 和 eigen 需要自己下载安装。在 2019 年照着教程安装它们并不是很困难的事情。</p>

<h3 id="使用-pybind11">使用 pybind11</h3>

<p>下面列举了三种用法。</p>

<p>最简单的情况，我们将 Python 里的代码复制一份到 C++ 里，再处理这些数据。例如，我们可以写一个 <code class="language-plaintext highlighter-rouge">func.cpp</code> 的函数来处理数据，并且写一个对应的头文件。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// func.cpp</span>
<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// func.hpp</span>
<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">);</span>
</code></pre></div></div>

<p>同时我们写一个 <code class="language-plaintext highlighter-rouge">wrap.py</code> 的文件</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//wrap.cpp</span>
<span class="cp">#include</span> <span class="cpf">&lt;pybind11/pybind11.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"funcs.hpp"</span><span class="cp">
</span>
<span class="k">namespace</span> <span class="n">py</span> <span class="o">=</span> <span class="n">pybind11</span><span class="p">;</span>

<span class="n">PYBIND11_MODULE</span><span class="p">(</span><span class="n">wrap</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">m</span><span class="p">.</span><span class="n">doc</span><span class="p">()</span> <span class="o">=</span> <span class="s">"pybind11 example plugin"</span><span class="p">;</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add</span><span class="p">,</span> <span class="s">"Add two numbers"</span><span class="p">,</span> <span class="s">"i"</span><span class="n">_a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="s">"j"</span><span class="n">_a</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// default initial values</span>
<span class="p">}</span>
</code></pre></div></div>

<p>之后，我们在目录下执行编译</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g++ <span class="nt">-O3</span> <span class="nt">-Wall</span> <span class="nt">-shared</span> <span class="nt">-std</span><span class="o">=</span>c++11 <span class="nt">-fPIC</span> <span class="se">\</span>
<span class="sb">`</span>python3 <span class="nt">-m</span> pybind11 <span class="nt">--includes</span><span class="sb">`</span> <span class="se">\</span>
<span class="nt">-I</span>/usr/local/include <span class="se">\</span>
<span class="sb">`</span>python3-config <span class="nt">--ldflags</span><span class="sb">`</span> <span class="se">\</span>
<span class="nt">-o</span> wrap<span class="sb">`</span>python3-config <span class="nt">--extension-suffix</span><span class="sb">`</span> <span class="se">\</span>
funcs.cpp wrap.cpp
</code></pre></div></div>

<p>最终就会得到一个名为 <code class="language-plaintext highlighter-rouge">wrap.cpython-37m-darwin.so</code> 的文件。我们可以在 <code class="language-plaintext highlighter-rouge">python</code> 里直接执行</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">wrap</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">wrap</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">3</span>
</code></pre></div></div>

<p>我们可以写一个 <code class="language-plaintext highlighter-rouge">setup.py</code> 文件来简化编译，这样用户就可以用</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python setup.py build_ext <span class="nt">-i</span>
</code></pre></div></div>

<p>来编译需要的 <code class="language-plaintext highlighter-rouge">wrap</code> 模块。文件 <code class="language-plaintext highlighter-rouge">setup.py</code> 的内容如下</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="n">distutils</span> <span class="kn">import</span> <span class="n">sysconfig</span>

<span class="n">cpp_args</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">-std=c++11</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-stdlib=libc++</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">-mmacosx-version-min=10.7</span><span class="sh">'</span><span class="p">]</span>

<span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nc">Extension</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">wrap</span><span class="sh">'</span><span class="p">,</span>
        <span class="p">[</span><span class="sh">'</span><span class="s">funcs.cpp</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">func_wrap.cpp</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">pybind11/include</span><span class="sh">'</span><span class="p">],</span>
    <span class="n">language</span><span class="o">=</span><span class="sh">'</span><span class="s">c++</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">extra_compile_args</span> <span class="o">=</span> <span class="n">cpp_args</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">]</span>

<span class="nf">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">wrap</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="sh">'</span><span class="s">0.0.1</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">author</span><span class="o">=</span><span class="sh">'</span><span class="s">Yushi Yang</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">author_email</span><span class="o">=</span><span class="sh">'</span><span class="s">yushi.yang@bristol.ac.uk</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Example</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">ext_modules</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>最终得到的东西和之前是一样的。</p>

<p>比起 <code class="language-plaintext highlighter-rouge">setup.py</code>，在开发的时候更加方便的选择是 <code class="language-plaintext highlighter-rouge">cppimport</code>。它让我们在更改 c++ 代码之后，不需重复地使用 <code class="language-plaintext highlighter-rouge">python setup.py build_ext -i</code> 来编译。</p>

<p>为了使用它，我们需要更改我们的 <code class="language-plaintext highlighter-rouge">wrap.cpp</code> 文件。作为对比，我们创建一个 <code class="language-plaintext highlighter-rouge">ez_wrap.cpp</code></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ez_wrap.cpp</span>

<span class="o">&lt;%</span>
<span class="n">cfg</span><span class="p">[</span><span class="err">'</span><span class="n">compiler_args</span><span class="err">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">c</span><span class="o">++</span><span class="mi">11</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="o">-</span><span class="n">stdlib</span><span class="o">=</span><span class="n">libc</span><span class="o">++</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="o">-</span><span class="n">mmacosx</span><span class="o">-</span><span class="n">version</span><span class="o">-</span><span class="n">min</span><span class="o">=</span><span class="mf">10.7</span><span class="err">'</span><span class="p">]</span>
<span class="n">cfg</span><span class="p">[</span><span class="err">'</span><span class="n">sources</span><span class="err">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="n">funcs</span><span class="p">.</span><span class="n">cpp</span><span class="err">'</span><span class="p">]</span>
<span class="n">setup_pybind11</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="o">%&gt;</span>

<span class="cp">#include</span> <span class="cpf">&lt;pybind11/pybind11.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;pybind11/stl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"funcs.hpp"</span><span class="cp">
</span>
<span class="k">namespace</span> <span class="n">py</span> <span class="o">=</span> <span class="n">pybind11</span><span class="p">;</span>

<span class="n">PYBIND11_MODULE</span><span class="p">(</span><span class="n">ez_wrap</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 注意这里</span>
    <span class="n">m</span><span class="p">.</span><span class="n">doc</span><span class="p">()</span> <span class="o">=</span> <span class="s">"pybind11 example plugin"</span><span class="p">;</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add</span><span class="p">,</span> <span class="s">"Add two numbers"</span><span class="p">,</span> <span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">"i"</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">"j"</span><span class="p">)</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>代码最开始的标记就是为了 <code class="language-plaintext highlighter-rouge">cppimport</code> 服务的。在我们使用 <code class="language-plaintext highlighter-rouge">pip install cppimport</code> 之后，我们可以「直接」导入我们的 c++ 模块。</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">cppimport</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">wrap</span> <span class="o">=</span> <span class="n">cppimport</span><span class="p">.</span><span class="nf">imp</span><span class="p">(</span><span class="sh">"</span><span class="s">ez_wrap</span><span class="sh">"</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">wrap</span><span class="p">.</span><span class="nf">add</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">3</span>
</code></pre></div></div>

<p>要注意的是，<code class="language-plaintext highlighter-rouge">PYBIND11_MODULE(ez_wrap, m)</code> 里第一个变量的名字，需要和文件名 <code class="language-plaintext highlighter-rouge">ez_wrap.cpp</code> 的前缀一致，否则会得到下面的警告</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ImportError: dynamic module does not define module export function (PyInit_ez_wrap)
</code></pre></div></div>

<h3 id="使用-numpy">使用 numpy</h3>

<p><code class="language-plaintext highlighter-rouge">pybind11</code> 可以让 c++ 代码处理 <code class="language-plaintext highlighter-rouge">numpy</code> 数组。每一个 <code class="language-plaintext highlighter-rouge">numpy</code> 数组都实现了 <code class="language-plaintext highlighter-rouge">Pyhton</code> 中的 <code class="language-plaintext highlighter-rouge">buffer protocol</code>。简而言之，通过一些特殊的协议，我们可以在内存中开辟一块「连续的」区域来存储我们的数据，并且共享这块数据的指针。<a href="https://jakevdp.github.io/blog/2014/05/05/introduction-to-the-python-buffer-protocol/">这个博客</a>里有一个对 <code class="language-plaintext highlighter-rouge">buffer protocol</code> 的简单介绍。</p>

<p>如果我们想把一个 <code class="language-plaintext highlighter-rouge">Python</code> 里的 <code class="language-plaintext highlighter-rouge">np.ndarray</code> 读取到 c++ 里，我们只需要使用它的 <code class="language-plaintext highlighter-rouge">request</code> 放法，得到下面的结构体</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">buffer_info</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">itemsize</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">format</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ndim</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span> <span class="n">shape</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span> <span class="n">strides</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>这里面的 <code class="language-plaintext highlighter-rouge">ptr</code> 指向数据块；我们可以用它「直接」访问存储与 <code class="language-plaintext highlighter-rouge">numpy</code> 里的数据。</p>

<p>我们需要导入 <code class="language-plaintext highlighter-rouge">numpy</code> 对应的头文件来使用相关的功能。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;pybind11/numpy.h&gt;</span><span class="cp">
</span></code></pre></div></div>

<p>下面的例子是读取一个 <code class="language-plaintext highlighter-rouge">numpy</code> 数组并且改变这个数组：将每个数字换成它的一倍。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">arr_db</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">xs</span><span class="p">){</span>
    <span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span> <span class="n">info</span> <span class="o">=</span> <span class="n">xs</span><span class="p">.</span><span class="n">request</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">r</span> <span class="o">:</span> <span class="n">info</span><span class="p">.</span><span class="n">shape</span><span class="p">){</span>
        <span class="n">n</span> <span class="o">*=</span> <span class="n">r</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们可以在 Python 里导入这个模块</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">cnp</span> <span class="o">=</span> <span class="n">cppimport</span><span class="p">.</span><span class="nf">imp</span><span class="p">(</span><span class="sh">"</span><span class="s">cnp</span><span class="sh">"</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">a</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> 
<span class="nf">array</span><span class="p">([[</span><span class="mf">0.49394052</span><span class="p">,</span> <span class="mf">0.14228716</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">0.13781544</span><span class="p">,</span> <span class="mf">0.51710877</span><span class="p">]])</span>
       
<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">cnp</span><span class="p">.</span><span class="nf">arr_db</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">a</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> 
<span class="nf">array</span><span class="p">([[</span><span class="mf">0.98788103</span><span class="p">,</span> <span class="mf">0.28457432</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">0.27563088</span><span class="p">,</span> <span class="mf">1.03421754</span><span class="p">]])</span>
</code></pre></div></div>

<p>下面的例子是读取一个 <code class="language-plaintext highlighter-rouge">numpy</code> 数组并且计算每一个数字的平方。这个函数不会改变已有的数组，而是会返回一个新数组。
（这段代码有一点不好：输入数组可以是 n 维的，不过返回的数组是 1 维。）</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">arr_sqr</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">arr</span><span class="p">){</span>
    <span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span> <span class="n">buf_1</span> <span class="o">=</span> <span class="n">arr</span><span class="p">.</span><span class="n">request</span><span class="p">();</span>

    <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf_1</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

    <span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span> <span class="n">buf_2</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">request</span><span class="p">();</span>

    <span class="kt">double</span> <span class="o">*</span><span class="n">ptr_1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf_1</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span>
           <span class="o">*</span><span class="n">ptr_2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf_2</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">max_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">buf_1</span><span class="p">.</span><span class="n">ndim</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">max_index</span> <span class="o">*=</span> <span class="n">buf_1</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="o">*</span><span class="n">ptr_2</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr_1</span> <span class="o">*</span> <span class="o">*</span><span class="n">ptr_1</span><span class="p">;</span>
        <span class="n">ptr_1</span><span class="o">++</span><span class="p">;</span>
        <span class="n">ptr_2</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们可以在 Python 里导入这个模块。</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">cppimport</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">cnp</span> <span class="o">=</span> <span class="n">cppimport</span><span class="p">.</span><span class="nf">imp</span><span class="p">(</span><span class="sh">"</span><span class="s">cnp</span><span class="sh">"</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">np</span><span class="p">.</span><span class="nf">allclose</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">power</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nf">ravel</span><span class="p">(),</span> <span class="n">cnp</span><span class="p">.</span><span class="nf">arr_sqr</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="bp">True</span>
</code></pre></div></div>

<h3 id="使用-eigen">使用 eigen</h3>

<p>在 C++ 里，我们可以用库 <code class="language-plaintext highlighter-rouge">Eigen</code> 来完成线性代数计算。更棒的是，我们可以直接把 <code class="language-plaintext highlighter-rouge">Python</code> 里的 <code class="language-plaintext highlighter-rouge">numpy</code> 数组直接转化成 <code class="language-plaintext highlighter-rouge">Eigen</code> 里对应的数据结构。</p>

<p>在使用 <code class="language-plaintext highlighter-rouge">eigen</code> 的时候，我们需要引入 <code class="language-plaintext highlighter-rouge">pybind11</code> 的 <code class="language-plaintext highlighter-rouge">eigen</code> 模块，以及我们实际使用的 <code class="language-plaintext highlighter-rouge">Eigen</code> 库。</p>

<p>下面是利用 <code class="language-plaintext highlighter-rouge">eigen</code> 库计算矩阵的逆和行列式的例子。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//eig.cpp</span>
<span class="o">&lt;%</span>
<span class="n">cfg</span><span class="p">[</span><span class="err">'</span><span class="n">compiler_args</span><span class="err">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">c</span><span class="o">++</span><span class="mi">11</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="o">-</span><span class="n">stdlib</span><span class="o">=</span><span class="n">libc</span><span class="o">++</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="o">-</span><span class="n">mmacosx</span><span class="o">-</span><span class="n">version</span><span class="o">-</span><span class="n">min</span><span class="o">=</span><span class="mf">10.7</span><span class="err">'</span><span class="p">]</span>
<span class="n">setup_pybind11</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="o">%&gt;</span>

<span class="cp">#include</span> <span class="cpf">&lt;pybind11/pybind11.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;pybind11/eigen.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Eigen/LU&gt;</span><span class="cp">
</span>
<span class="k">namespace</span> <span class="n">py</span> <span class="o">=</span> <span class="n">pybind11</span><span class="p">;</span>


<span class="c1">// input numpy array output number</span>
<span class="kt">double</span> <span class="nf">det</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span> <span class="n">arr</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">arr</span><span class="p">.</span><span class="n">determinant</span><span class="p">();</span>
<span class="p">}</span>


<span class="c1">// input numpy array output numpy array</span>
<span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span> <span class="nf">inv</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span> <span class="n">arr</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">arr</span><span class="p">.</span><span class="n">inverse</span><span class="p">();</span>
<span class="p">}</span>


<span class="c1">// example of using Eigen</span>

<span class="n">PYBIND11_MODULE</span><span class="p">(</span><span class="n">eig</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">m</span><span class="p">.</span><span class="n">doc</span><span class="p">()</span> <span class="o">=</span> <span class="s">"pybind11 example plugin"</span><span class="p">;</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"det"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">det</span><span class="p">);</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"inv"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inv</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们可以直接引用这个模块</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">cppimport</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">eig</span> <span class="o">=</span> <span class="n">cppimport</span><span class="p">.</span><span class="nf">imp</span><span class="p">(</span><span class="sh">'</span><span class="s">eig</span><span class="sh">'</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">np</span><span class="p">.</span><span class="nf">allclose</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">inv</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">eig</span><span class="p">.</span><span class="nf">inv</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="bp">True</span>
</code></pre></div></div>

<h2 id="元编程">元编程</h2>

<h3 id="概念">概念</h3>

<ul>
  <li>元编程 ( metaprogramming ) - 如果写出的程序有能力 了解/改变 自己，这样的编程就叫元编程。</li>
  <li>元类 ( metaclass ) - Python 里的一种，支持元编程的 技巧</li>
</ul>

<p>元编程是深奥的面向对象 ( OOP ) 技巧。大部分的 Python 程序不需要使用它。但是你可以通过 metaclass 来实现很多黑魔法。不过请看一下 Python 专家的 真知灼见：</p>

<blockquote>
  <p>“Metaclasses are deeper magic than 99% of users should ever worry about. If you wonder whether you need them, you don’t (the people who actually need them know with certainty that they need them, and don’t need an explanation about why).”</p>

  <p>— Tim Peters</p>
</blockquote>

<p>不过，即使我们用不上，我们也有理由理解 Python 的元类。</p>

<h3 id="新式类和旧式类">新式类和旧式类</h3>

<p>在 Python 2 里，一个 实例 的 <code class="language-plaintext highlighter-rouge">__class__</code> 特性是它的 类；但是这个实例的 <code class="language-plaintext highlighter-rouge">type</code> 是 <code class="language-plaintext highlighter-rouge">instance</code>。下面的代码给出了例子。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span> <span class="k">pass</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Foo</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">x</span><span class="p">.</span><span class="n">__class__</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">__main__</span><span class="p">.</span><span class="n">Foo</span> <span class="n">at</span> <span class="mh">0x10c32f600</span><span class="o">&gt;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nf">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">instance</span>  <span class="c1"># 不是 __main__.Foo
</span></code></pre></div></div>

<p>这样的类被称为 旧式类 ( Old-Style Class )。与之对应，在 Python 3 中，我们拥有了 新式类 ( New-Style Class)。对于 新式类 的实例，其 <code class="language-plaintext highlighter-rouge">__class__</code> 与 <code class="language-plaintext highlighter-rouge">type</code> 都是这个 类 本身。下面的代码给出了例子。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span> <span class="k">pass</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Foo</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">x</span><span class="p">.</span><span class="n">__class__</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">__main__</span><span class="p">.</span><span class="n">Foo</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nf">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">__main__</span><span class="p">.</span><span class="n">Foo</span>  <span class="c1"># 与 __class__ 一致
</span></code></pre></div></div>

<h3 id="元类类的类">元类：类的类</h3>

<p>在 Python 中，所有东西都是对象 ( everything is an object )。所以 Python 里的 类 也是对象。这些 类 也有它们的 <code class="language-plaintext highlighter-rouge">type</code>。它们的 <code class="language-plaintext highlighter-rouge">type</code> 就是 <code class="language-plaintext highlighter-rouge">type</code>，<code class="language-plaintext highlighter-rouge">type</code> 自己是一个 元类。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span> <span class="k">pass</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="nf">type</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="nb">type</span>
</code></pre></div></div>

<p>所有 Python 自带的类的 <code class="language-plaintext highlighter-rouge">type</code> 也是 <code class="language-plaintext highlighter-rouge">type</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
   <span class="p">...:</span>     <span class="nf">print</span><span class="p">(</span><span class="nf">type</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
   <span class="p">...:</span> 
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">type</span><span class="sh">'</span><span class="s">&gt;
&lt;class </span><span class="sh">'</span><span class="nb">type</span><span class="sh">'</span><span class="s">&gt;
&lt;class </span><span class="sh">'</span><span class="nb">type</span><span class="sh">'</span><span class="s">&gt;
&lt;class </span><span class="sh">'</span><span class="nb">type</span><span class="sh">'</span><span class="s">&gt;
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">type</code> 的 元类 也是 <code class="language-plaintext highlighter-rouge">type</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nf">type</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nb">type</span>
</code></pre></div></div>

<p>下面的图总结了 Python 里的层级结构。</p>

<pre class="asciiart">
┌───────────┐         
│           │         
│           ▼         
│  ┌─────────────────┐
└──│      type       │
   └─────────────────┘
            ▲         
            │         
            │         
   ┌─────────────────┐
   │       Foo       │
   │ (or any class)  │
   └─────────────────┘
            ▲         
            │         
            │         
   ┌─────────────────┐
   │    x = Foo()    │
   │ (the instances) │
   └─────────────────┘
</pre>

<h3 id="作用动态定义类">作用：动态定义类</h3>

<p>我们可以用 <code class="language-plaintext highlighter-rouge">type</code> 动态地创建类，语法如下</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">type</span><span class="p">(</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">base</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">dct</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div></div>

<p>其中的三个参数分别是</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">name</code>: 类的名字</li>
  <li><code class="language-plaintext highlighter-rouge">bases</code>: 类的父类</li>
  <li><code class="language-plaintext highlighter-rouge">dct</code>：类的命名空间字典，包含了类的具体定义</li>
</ol>

<p>下面是一个具体的例子。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">Foo</span> <span class="o">=</span> <span class="nf">type</span><span class="p">(</span><span class="sh">'</span><span class="s">Foo</span><span class="sh">'</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{})</span> <span class="c1"># 等价于 class Foo: pass
</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Foo</span><span class="p">()</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">x</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">__main__</span><span class="p">.</span><span class="n">Foo</span> <span class="n">at</span> <span class="mh">0x104349590</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>下面是一个包含 父类 和 <code class="language-plaintext highlighter-rouge">dct</code> 的例子</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">Foo</span> <span class="o">=</span> <span class="nf">type</span><span class="p">(</span><span class="sh">'</span><span class="s">Foo</span><span class="sh">'</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{})</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">Bar</span> <span class="o">=</span> <span class="nf">type</span><span class="p">(</span><span class="sh">'</span><span class="s">Bar</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">Foo</span><span class="p">,),</span> <span class="nf">dict</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Bar</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">x</span><span class="p">.</span><span class="n">T</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">1</span>
</code></pre></div></div>

<p>下面是 <code class="language-plaintext highlighter-rouge">dct</code> 里有类的 方法 ( method ) 的例子</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">Foo</span> <span class="o">=</span> <span class="nf">type</span><span class="p">(</span>
   <span class="p">...:</span>     <span class="sh">'</span><span class="s">Foo</span><span class="sh">'</span><span class="p">,</span>
   <span class="p">...:</span>     <span class="p">(),</span>
   <span class="p">...:</span>     <span class="p">{</span>
   <span class="p">...:</span>         <span class="sh">'</span><span class="s">T</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="p">...:</span>         <span class="sh">'</span><span class="s">get_T</span><span class="sh">'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="n">T</span>
   <span class="p">...:</span>     <span class="p">}</span>
   <span class="p">...:</span> <span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Foo</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">x</span><span class="p">.</span><span class="nf">get_T</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="mi">1</span>
</code></pre></div></div>

<h3 id="自定义元类">自定义元类</h3>

<p>如果我们使用下面的代码创造一个类</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span> <span class="k">pass</span>
<span class="n">f</span> <span class="o">=</span> <span class="nc">Foo</span><span class="p">()</span>
</code></pre></div></div>

<p>当 Python 解释器遇到 <code class="language-plaintext highlighter-rouge">Foo()</code> 的时候，下面的东西会发生</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Foo</code> 的 parent class 的 <code class="language-plaintext highlighter-rouge">__call__()</code> 方法会被使用。因为 Python 3 里的类的 parent class 都是 <code class="language-plaintext highlighter-rouge">type</code>, 所以这里会使用 <code class="language-plaintext highlighter-rouge">type</code> 的 <code class="language-plaintext highlighter-rouge">__call__()</code></li>
  <li>在 <code class="language-plaintext highlighter-rouge">type</code> 的 <code class="language-plaintext highlighter-rouge">__call__()</code> 里，下面的连个方法会被调用。
    <ul>
      <li><code class="language-plaintext highlighter-rouge">__new__()</code></li>
      <li><code class="language-plaintext highlighter-rouge">__init__()</code></li>
    </ul>
  </li>
</ol>

<p>如果 <code class="language-plaintext highlighter-rouge">Foo</code> 没有定义 <code class="language-plaintext highlighter-rouge">__new__</code> 和 <code class="language-plaintext highlighter-rouge">__init__</code>，那么这两个方法会从 <code class="language-plaintext highlighter-rouge">type</code> 继承。我们可以用 monkey-patching 来修改 <code class="language-plaintext highlighter-rouge">__new__</code> 来改变一个类的行为。下面展示了一个例子。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span> <span class="k">pass</span>     
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">f</span> <span class="o">=</span> <span class="nc">Foo</span><span class="p">();</span> <span class="n">f</span><span class="p">.</span><span class="n">T</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="nb">AttributeError</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
   <span class="p">...:</span>     <span class="n">x</span> <span class="o">=</span> <span class="nb">object</span><span class="p">.</span><span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
   <span class="p">...:</span>     <span class="n">x</span><span class="p">.</span><span class="n">T</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="p">...:</span>     <span class="k">return</span> <span class="n">x</span>
   <span class="p">...:</span> 

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">Foo</span><span class="p">.</span><span class="n">__new__</span> <span class="o">=</span> <span class="n">new</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">g</span> <span class="o">=</span> <span class="nc">Foo</span><span class="p">()</span>  <span class="c1"># 重新定义了 __new__ 后，所有的实例都有 .T 特性
</span><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">g</span><span class="p">.</span><span class="n">T</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">1</span>
</code></pre></div></div>

<h3 id="修改-type">修改 type</h3>

<p>如果我们修改 <code class="language-plaintext highlighter-rouge">type</code> 的 <code class="language-plaintext highlighter-rouge">__new__</code> 我们岂不是可以修改「所有没有 <code class="language-plaintext highlighter-rouge">__new__</code> 的类」的行为？让我们试一试</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
   <span class="p">...:</span>     <span class="n">x</span> <span class="o">=</span> <span class="nb">type</span><span class="p">.</span><span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
   <span class="p">...:</span>     <span class="n">x</span><span class="p">.</span><span class="n">T</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="p">...:</span>     <span class="k">return</span> <span class="n">x</span>
   <span class="p">...:</span> 

<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">Foo</span><span class="p">.</span><span class="n">__new__</span> <span class="o">=</span> <span class="n">new</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span> <span class="o">=</span> <span class="n">new</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="nb">TypeError</span>                                 <span class="nc">Traceback </span><span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">9</span><span class="n">f1d36c02af0</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span> <span class="o">=</span> <span class="n">new</span>

<span class="nb">TypeError</span><span class="p">:</span> <span class="n">can</span><span class="sh">'</span><span class="s">t set attributes of built-in/extension type </span><span class="sh">'</span><span class="nb">type</span><span class="sh">'</span><span class="s">
</span></code></pre></div></div>

<p>Python 强行制止了这种行为。</p>

<h3 id="自定义元类-1">自定义元类</h3>

<p>我们可以通过自定义元类，来达到类似「修改 type」的效果。下面的代码是一个例子。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 定义元类
</span><span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="p">...:</span>     <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
    <span class="p">...:</span>         <span class="n">x</span> <span class="o">=</span> <span class="nf">super</span><span class="p">().</span><span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
    <span class="p">...:</span>         <span class="n">x</span><span class="p">.</span><span class="n">T</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">...:</span>         <span class="k">return</span> <span class="n">x</span>
    <span class="p">...:</span> 
<span class="c1"># “使用”元类
</span><span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">Meta</span><span class="p">):</span> <span class="k">pass</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">Bar</span><span class="p">.</span><span class="n">T</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="mi">1</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="nc">Bar</span><span class="p">()</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">b</span><span class="p">.</span><span class="n">T</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="mi">1</span>

<span class="c1"># 所有从 元类 构造的类，都有共同的特性
</span><span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">Qux</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">Meta</span><span class="p">):</span> <span class="k">pass</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="n">Qux</span><span class="p">.</span><span class="n">T</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="mi">1</span>
</code></pre></div></div>

<h3 id="避免使用元类">避免使用元类</h3>

<p>如果要「批量制造 具有共同点 的类」，我们可以用别的方法来达到相同的效果。通常我们应该用下面的这些，更简单的方法。</p>

<p>使用继承：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">Base</span><span class="p">:</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">X</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span> <span class="k">pass</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">Y</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span> <span class="k">pass</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">X</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">.</span><span class="n">T</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<p>使用类的装饰器：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
   <span class="p">...:</span>     <span class="k">class</span> <span class="nc">NewClass</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
   <span class="p">...:</span>         <span class="n">T</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="p">...:</span>     <span class="k">return</span> <span class="n">NewClass</span>
   <span class="p">...:</span> 

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="nd">@decorator</span>
   <span class="p">...:</span> <span class="k">class</span> <span class="nc">X</span><span class="p">:</span> <span class="k">pass</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="nd">@decorator</span>
   <span class="p">...:</span> <span class="k">class</span> <span class="nc">Y</span><span class="p">:</span> <span class="k">pass</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">X</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">.</span><span class="n">T</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="常用内置函数">常用内置函数</h2>

<h3 id="enumerate">enumerate()</h3>

<p><code class="language-plaintext highlighter-rouge">enumerate()</code> 可同时获取循环中的下标和元素：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="sh">'</span><span class="s">abcd</span><span class="sh">'</span>
<span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Index: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">; Char: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="zip">zip()</h3>

<p><code class="language-plaintext highlighter-rouge">zip()</code> 可在每次循环时从各个序列分别取出一个元素：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">la</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="nf">for </span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">la</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">lc</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="filter">filter()</h3>

<p><code class="language-plaintext highlighter-rouge">filter()</code> 使用一个函数参数来筛选序列中的元素。在 Python 3 中，返回的是循环对象。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">scatter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">(),</span> <span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">50</span><span class="p">)]</span>
<span class="n">sfx</span><span class="p">,</span> <span class="n">sfy</span> <span class="o">=</span> <span class="nf">zip</span><span class="p">(</span><span class="o">*</span><span class="nf">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">scatter</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="o">*</span><span class="nf">zip</span><span class="p">(</span><span class="o">*</span><span class="n">scatter</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">),</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">sfx</span><span class="p">,</span> <span class="n">sfy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">),</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>
<p>(图解：上图显示原始数据，下图显示筛选后的数据，所有 y 值小于 0.5 的点被过滤掉。)</p>

<h3 id="reduce">reduce()</h3>

<p><code class="language-plaintext highlighter-rouge">reduce()</code> 使用一个接收两个参数的函数，来累进地应用于序列。</p>

<p>Python 2:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">reduce</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]))</span>
</code></pre></div></div>

<p>Python 3:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">reduce</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]))</span>
</code></pre></div></div>

<h2 id="动态类型">动态类型</h2>

<h3 id="概念-1">概念</h3>

<p>Python 的变量类型是动态的，允许一个变量从一种类型变为另一种类型，与静态语言如 C 和 C++ 不同。Python 的变量实际上是对象的引用。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">a = 3</code>：创建整数对象3并使<code class="language-plaintext highlighter-rouge">a</code>指向它。</li>
  <li><code class="language-plaintext highlighter-rouge">a = "3"</code>：创建字符串对象”3”，<code class="language-plaintext highlighter-rouge">a</code>现在指向它。整数对象3不再被引用。</li>
</ul>

<p>注：</p>
<ul>
  <li>Python 会自动销毁没有引用的对象。</li>
  <li>Python 缓存小整数和短字符串。</li>
</ul>

<h3 id="引用示例">引用示例</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span>    <span class="c1"># b, a 指向同一个对象5
</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># a 现在指向新对象7
</span></code></pre></div></div>

<p>多个引用可以指向同一个对象，但如果一个引用的值改变，这只影响该引用，而不影响其他引用。</p>

<h3 id="列表引用">列表引用</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">L1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">L2</span> <span class="o">=</span> <span class="n">L1</span>
<span class="n">L3</span> <span class="o">=</span> <span class="n">L1</span>

<span class="n">L1</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># L1 的指向改变
</span><span class="n">L2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># L2 和 L3 所指的列表内容改变
</span></code></pre></div></div>

<p>修改 L2 或 L3 所指向列表的内容会影响彼此，因为它们引用的是同一个对象。</p>

<h3 id="参数传递与动态类型">参数传递与动态类型</h3>

<p>在 Python，函数处理不可变和可变对象时，表现是不同的。不可变对象（immutable）的处理如下，</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>   <span class="c1"># 输出：1
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">x</code> 是新引用，指向 <code class="language-plaintext highlighter-rouge">a</code> 的对象。操作 <code class="language-plaintext highlighter-rouge">x</code> 不影响 <code class="language-plaintext highlighter-rouge">a</code>。</p>

<p>函数对可变对象处理，实例如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="nf">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>   <span class="c1"># 输出：[100, 2, 3]
</span></code></pre></div></div>

<p>传递可变对象可能改变原始对象。注意此问题以避免错误。</p>

<h2 id="上下文管理器">上下文管理器</h2>

<p>从Python 2.5开始，上下文管理器提供了规定对象使用范围的语法，一旦进入或退出此范围，特定的操作会被触发（例如对象的分配或释放）。其语法为 <code class="language-plaintext highlighter-rouge">with...as...</code>。</p>

<p>例：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">File_name</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># 使用f，之后f自动关闭
</span></code></pre></div></div>

<p>使用上下文管理器操作文件：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">new.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">closed</span><span class="p">)</span>  <span class="c1"># 输出：False
</span>
<span class="n">f</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">closed</span><span class="p">)</span>  <span class="c1"># 输出：True
</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">new.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">closed</span><span class="p">)</span>  <span class="c1"># 输出：False
</span>
<span class="nf">print</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">closed</span><span class="p">)</span>  <span class="c1"># 输出：True
</span></code></pre></div></div>

<h3 id="工作原理">工作原理</h3>

<p>使用上下文管理器，Python在进入块前调用对象的 <code class="language-plaintext highlighter-rouge">__enter__()</code>，在退出时调用 <code class="language-plaintext highlighter-rouge">__exit__()</code>。</p>

<p>对于文件对象 <code class="language-plaintext highlighter-rouge">f</code>，它定义了 <code class="language-plaintext highlighter-rouge">__enter__()</code> 和 <code class="language-plaintext highlighter-rouge">__exit__()</code>（可通过 <code class="language-plaintext highlighter-rouge">dir(f)</code> 查看）。<code class="language-plaintext highlighter-rouge">f</code> 的 <code class="language-plaintext highlighter-rouge">__exit__()</code> 中调用了 <code class="language-plaintext highlighter-rouge">self.close()</code>，所以不需手动关闭文件。</p>

<h3 id="自定义上下文管理器">自定义上下文管理器</h3>

<p>下列代码创建了一个带上下文管理器的类，并在上下文中使用它。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Ranter</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">you are ugly</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">god bless you</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">good luck</span><span class="sh">"</span><span class="p">)</span>

<span class="k">with</span> <span class="nc">Ranter</span><span class="p">()</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>执行结果：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">you</span> <span class="n">are</span> <span class="n">ugly</span>
<span class="n">god</span> <span class="n">bless</span> <span class="n">you</span>
<span class="n">good</span> <span class="n">luck</span>
</code></pre></div></div>

<h2 id="闭包">闭包</h2>

<p>闭包是函数式编程中的一个核心概念。在编程中，面向过程编程使用「函数」来组织代码，而面向对象编程使用「对象」。函数、对象以及闭包都有助于以结构化的方式组织代码并提高其可重用性。</p>

<p>在Python中，闭包是基于「函数对象」的。事实上，Python中的所有事物，包括函数，都是对象。这意味着我们可以像操作其他对象那样操作函数对象，如改变其名称或将其作为参数传递给其他函数。</p>

<h3 id="函数对象的作用域">函数对象的作用域</h3>

<p>函数对象有其自己的作用域，与其定义位置的层次相对应。例如，在下面的代码中，我们只能在<code class="language-plaintext highlighter-rouge">line_conf</code>的范围内使用在其内部定义的<code class="language-plaintext highlighter-rouge">line</code>函数：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">line_conf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">line</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># 在line_conf的范围外尝试使用line会报错
</span></code></pre></div></div>

<h3 id="闭包的实现">闭包的实现</h3>

<p>当一个函数引用了其作用域外的变量，且该函数被作为返回值，则这样的函数称为闭包。例如：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">line_conf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">line</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">line</span>

<span class="n">line</span> <span class="o">=</span> <span class="nf">line_conf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">line</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># 输出：2
</span></code></pre></div></div>

<p>闭包内的「环境变量」保存在函数对象的 <code class="language-plaintext highlighter-rouge">__closure__</code> 属性中。</p>

<h2 id="装饰器">装饰器</h2>

<p>装饰器是Python中的高级功能，允许我们在不修改原始代码的情况下增加或修改功能。装饰器简化了代码并提高了可读性。</p>

<h3 id="基本装饰器">基本装饰器</h3>

<p>装饰器通过在函数定义之前使用<code class="language-plaintext highlighter-rouge">@</code>符号来应用：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">F</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">new_F</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">The input is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s"> and </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">F</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_F</span>

<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">dist_sq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span>
</code></pre></div></div>

<h3 id="参数化的装饰器">参数化的装饰器</h3>

<p>有时，我们可能希望为装饰器提供参数来提供更多的灵活性：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dec_with_par</span><span class="p">(</span><span class="n">parameter</span><span class="o">=</span><span class="sh">""</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">new_func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">The input is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s"> and </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_func</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="nd">@dec_with_par</span><span class="p">(</span><span class="sh">"</span><span class="s">calculate squared sum</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dist_sq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span>
</code></pre></div></div>

<h3 id="装饰类">装饰类</h3>

<p>从Python 2.6开始，我们还可以使用装饰器来装饰类：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">old_class</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">new_class</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
            <span class="n">old_class</span><span class="p">.</span><span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="sh">"</span><span class="s">new</span><span class="sh">"</span>
    <span class="k">return</span> <span class="n">new_class</span>

<span class="nd">@decorator</span>
<span class="k">class</span> <span class="nc">Bird</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bird</span><span class="sh">"</span>

<span class="n">crow</span> <span class="o">=</span> <span class="nc">Bird</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">crow</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># 输出：bird
</span><span class="nf">print</span><span class="p">(</span><span class="n">crow</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>  <span class="c1"># 输出：new
</span></code></pre></div></div>

<h3 id="日志记录">日志记录</h3>

<p>当我们想要跟踪函数的行为时，日志记录是一个很有用的工具。使用装饰器，我们可以很容易地为任何函数添加日志记录功能，而不必修改函数本身的代码。</p>

<p>以下是一个简单的示例，展示如何使用装饰器来记录函数的调用信息：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">logging</span>

<span class="c1"># 配置日志记录
</span><span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Running </span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s"> with arguments </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s"> and keyword arguments </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="nd">@log_decorator</span>
<span class="k">def</span> <span class="nf">sample_function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</code></pre></div></div>

<p>在上述代码中，每次调用<code class="language-plaintext highlighter-rouge">sample_function</code>时，都会在日志中记录函数的名称以及传递给它的参数。</p>

<p>例如，调用<code class="language-plaintext highlighter-rouge">sample_function(1, b=2)</code>会在日志中产生以下条目：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO:root:Running sample_function with arguments (1,) and keyword arguments {'b': 2}
</code></pre></div></div>

<p>这种方法的优点是可以轻松地为任何函数添加日志记录功能，而无需对原始函数进行大量修改。</p>

<h2 id="内存管理">内存管理</h2>

<h3 id="对象的内存使用">对象的内存使用</h3>

<p>Python中的变量都是对象的引用。例如在赋值<code class="language-plaintext highlighter-rouge">a = 1</code>，<code class="language-plaintext highlighter-rouge">1</code>是一个整数对象，而<code class="language-plaintext highlighter-rouge">a</code>则是这个对象的引用。使用Python的<code class="language-plaintext highlighter-rouge">id()</code>函数，我们可以查询对象的内存地址：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">id</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>          <span class="c1"># 十进制的内存地址
</span><span class="nf">print</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="nf">id</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>     <span class="c1"># 十六进制的内存地址
</span></code></pre></div></div>

<p>Python优化了常用的小整数和短字符串等对象，使它们在内存中只存在一份。因此，多个引用指向相同的对象可能会有相同的内存地址：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<span class="nf">print</span><span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># True
</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">,</span> <span class="mi">12345</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># False
</span></code></pre></div></div>

<h3 id="引用计数">引用计数</h3>

<p>每个Python对象都维护着一个引用计数，表示有多少引用指向它。使用<code class="language-plaintext highlighter-rouge">sys.getrefcount()</code>可以查询对象的引用计数，但它的返回值会比实际引用计数多1（函数调用自身也是一次引用）：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sys</span> <span class="kn">import</span> <span class="n">getrefcount</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">getrefcount</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>  <span class="c1"># 2: a引用 + getrefcount的临时引用
</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">getrefcount</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>  <span class="c1"># 3
</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">getrefcount</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>  <span class="c1"># 6
</span></code></pre></div></div>

<h3 id="容器中的引用">容器中的引用</h3>

<p>容器对象（如列表、字典）保存的是其他对象的引用，而不是对象本身。我们还可以自定义类来引用其他对象：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FromObj</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">to_obj</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">to_obj</span> <span class="o">=</span> <span class="n">to_obj</span>

<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">a</span> <span class="o">=</span> <span class="nc">FromObj</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">id</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">to_obj</span><span class="p">)</span> <span class="o">==</span> <span class="nf">id</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>  <span class="c1"># True
</span><span class="nf">print</span><span class="p">(</span><span class="nf">getrefcount</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>  <span class="c1"># 3
</span></code></pre></div></div>

<p>在Python的全局作用域，变量其实都是全局字典中的键值对：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">globals</span><span class="p">()[</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">])</span>  <span class="c1"># 1
</span></code></pre></div></div>

<h3 id="引用环">引用环</h3>

<p>对象可以互相引用，形成一个引用环。即使对象自引用，也构成一个环：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="n">a</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="c1"># 检查引用环
</span><span class="nf">print</span><span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># True
</span><span class="nf">print</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># True
</span>
<span class="c1"># 自引用
</span><span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">a</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">a</span><span class="p">)</span>  <span class="c1"># True
</span></code></pre></div></div>

<h3 id="减少引用">减少引用</h3>

<p>使用<code class="language-plaintext highlighter-rouge">del</code>关键字可以删除一个引用，从而减少对象的引用计数：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">getrefcount</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>  <span class="c1"># 6
</span><span class="nf">del</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">getrefcount</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># 5
</span></code></pre></div></div>

<p>此外，<code class="language-plaintext highlighter-rouge">del</code>也可以删除容器中的元素：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="nf">del</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># [1, 2]
</span></code></pre></div></div>

<h3 id="垃圾回收">垃圾回收</h3>

<p>Python 自动执行「垃圾回收」 (garbage collection)，清除不再使用的对象。当对象的引用计数变为 0，该对象就成为垃圾，等待回收。</p>

<p>例如：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="nf">del</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</code></pre></div></div>

<p>在 <code class="language-plaintext highlighter-rouge">del(a)</code> 后，没有引用指向 <code class="language-plaintext highlighter-rouge">[1, 2, 3]</code>。这个对象如果留在内存中就是浪费。Python 会在特定条件下启动垃圾回收，基于「<strong>分配对象</strong>」和「<strong>取消分配对象</strong>」的差值。</p>

<p>使用 <code class="language-plaintext highlighter-rouge">gc.get_threshold()</code> 可查看该阈值：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">gc</span>
<span class="n">gc</span><span class="p">.</span><span class="nf">get_threshold</span><span class="p">()</span>  <span class="c1"># Output: (700, 10, 10)
</span></code></pre></div></div>

<h3 id="分代回收">分代回收</h3>

<p>Python 也使用「分代回收」策略，即分三代(0、1、2)。新建对象为 0 代。经历回收后仍存活的对象会升代。</p>

<p>例如，<code class="language-plaintext highlighter-rouge">get_threshold()</code> 的输出 <code class="language-plaintext highlighter-rouge">(700, 10, 10)</code> 表示：每 10 次 0 代回收触发 1 次 1 代回收；每 10 次 1 代回收触发 1 次 2 代回收。</p>

<p>可以使用 <code class="language-plaintext highlighter-rouge">set_threshold()</code> 调整：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gc</span><span class="p">.</span><span class="nf">set_threshold</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gc</span><span class="p">.</span><span class="nf">get_threshold</span><span class="p">()</span>  <span class="c1"># Output: (700, 10, 2)
</span></code></pre></div></div>

<h3 id="回收孤立的引用环">回收孤立的引用环</h3>

<p>存在的引用环会影响垃圾回收。例如：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="n">a</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</code></pre></div></div>

<p>创建了两个相互引用的列表对象。即使我们 <code class="language-plaintext highlighter-rouge">del(a)</code> 和 <code class="language-plaintext highlighter-rouge">del(b)</code>，它们的引用计数不为 0，导致不被回收。</p>

<pre class="asciiart">
     其它的对象
       ▼
     ┌───┐
  ┌──│ 1 │──┐             ┌────────┐
  │  └───┘  │             │        │
  ▼         ▼             │        ▼ 
┌───┐     ┌───┐         ┌───┐    ┌───┐
│ 1 │────▶│ 2 │         │ 1 │    │ 1 │
└───┘     └───┘         └───┘    └───┘
            │             ▲        │
     ┌───┐  │             │        │
     │ 1 │◀─┘             └────────┘
     └───┘                孤立的引用环
	非孤立的引用环
</pre>

<p>为解决此，Python 采用 <code class="language-plaintext highlighter-rouge">gc_ref</code> 机制。每个对象的引用计数被复制到 <code class="language-plaintext highlighter-rouge">gc_ref</code>，对于每个对象引用的对象，<code class="language-plaintext highlighter-rouge">gc_ref</code> 会减 1。</p>

<pre class="asciiart">
   其它的对象
       ▼
     ┌───┐ 1
  ┌──│ 1 │──┐             ┌────────┐
  │  └───┘  │             │        │
  ▼         ▼             │  0     ▼  0
┌───┐ 0   ┌───┐ 0       ┌───┐    ┌───┐
│ 1 │────▶│ 2 │         │ 1 │    │ 1 │
└───┘     └───┘         └───┘    └───┘
            │             ▲        │
   0 ┌───┐  │             │        │
     │ 1 │◀─┘             └────────┘
     └───┘                孤立的引用环
	非孤立的引用环
</pre>

<p>遍历后，非 0 的 <code class="language-plaintext highlighter-rouge">gc_ref</code> 对象及其引用被保留，其它被回收。</p>

<p>为了更简洁和直接，我对内容进行了优化，并尽量保持了原始信息。</p>

<h2 id="os-标准库">OS 标准库</h2>

<h3 id="ospath">os.path</h3>

<p>使用 <code class="language-plaintext highlighter-rouge">os.path</code> 模块，可以跨平台地处理文件路径。以下是其常用功能：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>

<span class="n">path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/Users/yushi/Desktop/Folder/file.txt</span><span class="sh">"</span>
<span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># 获取文件名: 'file.txt'
</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>   <span class="c1"># 获取目录: '/Users/yushi/Desktop/Folder'
</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>     <span class="c1"># 分割目录和文件名: ('/Users/yushi/Desktop/Folder', 'file.txt')
</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>    <span class="c1"># 路径是否存在: True
</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>   <span class="c1"># 文件大小: 12
</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getatime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># 上次读取时间: 1604155505.98391
</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># 上次修改时间: 1604155338.653522
</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>    <span class="c1"># 是否是文件: True
</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>     <span class="c1"># 是否是目录: False
</span></code></pre></div></div>

<h3 id="进程信息">进程信息</h3>

<p>os 模块中与进程相关的函数包括：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">uname()</code>：返回操作系统信息。</li>
  <li><code class="language-plaintext highlighter-rouge">mask()</code>：设置创建文件的权限 mask。</li>
  <li><code class="language-plaintext highlighter-rouge">get()</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">uid, euid, resuid, gid, egid, resgid</code>：权限信息。</li>
      <li><code class="language-plaintext highlighter-rouge">pid, pgid, ppid, sid</code>：进程信息。</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">put()</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">euid, egid</code>：更改 euid 和 egid。</li>
      <li><code class="language-plaintext highlighter-rouge">uid, gid</code>：更改 uid 和 gid，仅 super user 可用。</li>
      <li><code class="language-plaintext highlighter-rouge">pgid, sid</code>：更改进程组和会话。</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">getenviron()</code>：获取进程的环境变量。</li>
  <li><code class="language-plaintext highlighter-rouge">setenviron()</code>：设置进程的环境变量。</li>
</ul>

<h3 id="其他方法">其他方法</h3>

<p>以下是一些其他有用的 os 方法：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">)</span>      <span class="c1"># 创建文件夹
</span><span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span>         <span class="c1"># 查看当前目录下文件
</span><span class="n">os</span><span class="p">.</span><span class="nf">rmdir</span><span class="p">(</span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">)</span>      <span class="c1"># 删除文件夹
</span><span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>       <span class="c1"># 删除文件
</span><span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="sh">'</span><span class="s">file/folder</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 获取文件/文件夹信息
</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>             <span class="c1"># 获取当前目录
</span><span class="n">os</span><span class="p">.</span><span class="nf">symlink</span><span class="p">(</span><span class="sh">'</span><span class="s">p1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">p2</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 创建软链接，从 p2 指向 p1
</span></code></pre></div></div>

<h2 id="pickle">Pickle</h2>

<p>在 Python 中，所有如「变量」或「函数」都是「对象」。Python 运行时，它们存储于内存，但会因计算机关机而消失。幸运的是，我们可以将它们储存至硬盘上。</p>

<p>Python 中的对象是二进制的。我们可以序列化 (serialize) 这些对象并存入文件中。创建对象需要「对象的类」的定义，所以重建对象时也需要这一定义。</p>

<p>内置对象如整数或列表可以直接重建，但对于用户定义的对象，我们需先定义类。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pickle</span>

<span class="k">class</span> <span class="nc">bird</span><span class="p">():</span> 
    <span class="n">has_egg</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">crow</span> <span class="o">=</span> <span class="nf">bird</span><span class="p">()</span>
<span class="n">crow_str</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">crow</span><span class="p">)</span>  

<span class="c1"># 使用 pickle.dump 保存对象
</span><span class="n">starling</span> <span class="o">=</span> <span class="nf">bird</span><span class="p">()</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">starling.pkl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
	<span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">starling</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># 使用 pickle.load 读取对象
</span><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">starling.pkl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">starling</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="subprocess">Subprocess</h2>

<p>Python 运行时会创建进程。我们可以<code class="language-plaintext highlighter-rouge">fork</code>子进程并执行其他程序。<code class="language-plaintext highlighter-rouge">subprocess</code> 包提供这功能，并允许进程间文本通信。</p>

<p><code class="language-plaintext highlighter-rouge">subprocess</code>主要考虑：</p>
<ol>
  <li>父进程是否等待子进程。</li>
  <li>函数返回值。</li>
  <li><code class="language-plaintext highlighter-rouge">returncode</code>的处理。</li>
</ol>

<h3 id="常用功能">常用功能</h3>

<p>执行 shell 命令：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">subprocess</span>
<span class="n">subprocess</span><span class="p">.</span><span class="nf">call</span><span class="p">([</span><span class="sh">"</span><span class="s">ls</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-l</span><span class="sh">"</span><span class="p">])</span>  
</code></pre></div></div>

<p>捕捉命令错误：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">subprocess</span><span class="p">.</span><span class="nf">check_call</span><span class="p">([</span><span class="sh">"</span><span class="s">rm</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NotExist</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div>

<p>获取命令输出：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">subprocess</span><span class="p">.</span><span class="nf">check_output</span><span class="p">([</span><span class="sh">"</span><span class="s">ls</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div>

<h3 id="popen">Popen()</h3>

<p><code class="language-plaintext highlighter-rouge">Popen()</code> 是基础创建子进程的函数。与其他函数不同，创建后主进程不自动等待子进程。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nc">Popen</span><span class="p">([</span><span class="sh">"</span><span class="s">Ping</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">3</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">www.google.com</span><span class="sh">"</span><span class="p">])</span>
<span class="n">child</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>  <span class="c1"># 阻塞父进程
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">parent process continues</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="文本流控制">文本流控制</h3>

<p>子进程的输入/输出可以通过 <code class="language-plaintext highlighter-rouge">child.stdin</code>, <code class="language-plaintext highlighter-rouge">child.stdout</code>, <code class="language-plaintext highlighter-rouge">child.stderr</code> 控制。</p>

<p>使用 <code class="language-plaintext highlighter-rouge">Popen()</code> 可构成管道，如：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>

<span class="n">child_1</span> <span class="o">=</span> <span class="nc">Popen</span><span class="p">([</span><span class="sh">"</span><span class="s">ls</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-l</span><span class="sh">"</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">child_2</span> <span class="o">=</span> <span class="nc">Popen</span><span class="p">([</span><span class="sh">"</span><span class="s">wc</span><span class="sh">"</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">child_1</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">child_2</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
</code></pre></div></div>

<p>也可用于子进程输入：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">c</span> <span class="o">=</span> <span class="nc">Popen</span><span class="p">([</span><span class="sh">"</span><span class="s">cat</span><span class="sh">"</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">c</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Hello</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="循环器">循环器</h2>

<p>在 Python 3 中，循环器(iterator)是可以遍历的对象容器。通过调用 <code class="language-plaintext highlighter-rouge">__next__()</code> 方法，循环器将逐个返回其中的对象。当所有对象都被遍历完毕后，将抛出 <code class="language-plaintext highlighter-rouge">StopIteration</code> 错误。</p>

<p>Python 的 <code class="language-plaintext highlighter-rouge">itertools</code> 模块为我们提供了创建和操作循环器的强大工具。</p>

<h3 id="无穷循环器">无穷循环器</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">itertools</span> <span class="kn">import</span> <span class="n">count</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">repeat</span>
<span class="nf">count</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>        <span class="c1"># 从 0 开始，每次增加 3
</span><span class="nf">cycle</span><span class="p">(</span><span class="sh">'</span><span class="s">abc</span><span class="sh">'</span><span class="p">)</span>       <span class="c1"># 无尽地重复序列
</span><span class="nf">repeat</span><span class="p">(</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">)</span>        <span class="c1"># 无尽地重复 'x'
</span></code></pre></div></div>

<h3 id="函数式工具">函数式工具</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">itertools</span> <span class="kn">import</span> <span class="n">filterfalse</span>
<span class="nf">map</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>          <span class="c1"># -&gt; 2, 4, 6
</span><span class="nf">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>       <span class="c1"># -&gt; 3, 4
</span><span class="nf">filterfalse</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>  <span class="c1"># -&gt; 1, 2
</span></code></pre></div></div>

<h3 id="组合工具">组合工具</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">permutations</span><span class="p">,</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">combinations_with_replacement</span>
<span class="nf">chain</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>                  <span class="c1"># -&gt; [1, 2, 3, 4, 5, 6]
</span><span class="nf">product</span><span class="p">(</span><span class="sh">'</span><span class="s">ab</span><span class="sh">'</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>                        <span class="c1"># -&gt; [('a', 1), ('a', 2), ('b', 1), ('b', 2)]
</span><span class="nf">permutations</span><span class="p">(</span><span class="sh">'</span><span class="s">abc</span><span class="sh">'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>                       <span class="c1"># -&gt; [('a', 'b'), ('a', 'c'), ...]
</span><span class="nf">combinations</span><span class="p">(</span><span class="sh">'</span><span class="s">abc</span><span class="sh">'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>                       <span class="c1"># -&gt; [('a', 'b'), ('a', 'c'), ('b', 'c')]
</span><span class="nf">combinations_with_replacement</span><span class="p">(</span><span class="sh">'</span><span class="s">ab</span><span class="sh">'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>       <span class="c1"># -&gt; [('a', 'a'), ('a', 'b'), ('b', 'b')]
</span></code></pre></div></div>

<h3 id="groupby">groupby()</h3>

<p>使用 <code class="language-plaintext highlighter-rouge">groupby()</code> 函数可以按照指定的 <code class="language-plaintext highlighter-rouge">key</code> 函数将元素分组。下面的示例展示了如何使用它：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>

<span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span> <span class="k">return</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="sh">"</span><span class="s">A</span><span class="sh">"</span>

<span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="nf">groupby</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">rank</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="nf">list</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="sqlite3">Sqlite3</h2>

<p>关系型数据库使用二维表结构来组织数据，并支持 SQL（结构化查询语言）进行数据查询。表中的每一行是一个记录，每一列是一个字段。表与表之间可以通过主键和外键建立关系。</p>

<p>Python 标准库中的 <code class="language-plaintext highlighter-rouge">sqlite3</code> 模块提供了轻量级关系型数据库 SQLite 的接口。</p>

<h3 id="创建数据库">创建数据库</h3>

<p>创建<code class="language-plaintext highlighter-rouge">category</code>和<code class="language-plaintext highlighter-rouge">book</code>表，并建立它们之间的关系。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sqlite3</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="sh">"</span><span class="s">test.db</span><span class="sh">"</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>
<span class="n">c</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'''</span><span class="s">CREATE TABLE category(id INT PRIMARY KEY, name TEXT)</span><span class="sh">'''</span><span class="p">)</span>
<span class="n">conn</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
<span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h3 id="插入数据">插入数据</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="sh">"</span><span class="s">test.db</span><span class="sh">"</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>

<span class="n">c</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">"</span><span class="s">INSERT INTO category VALUES (1, </span><span class="sh">'</span><span class="s">science</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">c</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">"</span><span class="s">INSERT INTO category VALUES (?, ?)</span><span class="sh">"</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">philosophy</span><span class="sh">"</span><span class="p">))</span>
<span class="n">categories</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="sh">"</span><span class="s">medicine</span><span class="sh">"</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">"</span><span class="s">novel</span><span class="sh">"</span><span class="p">)]</span>
<span class="n">c</span><span class="p">.</span><span class="nf">executemany</span><span class="p">(</span><span class="sh">"</span><span class="s">INSERT INTO category VALUES (?, ?)</span><span class="sh">"</span><span class="p">,</span> <span class="n">categories</span><span class="p">)</span>

<span class="n">conn</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
<span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>science</td>
    </tr>
    <tr>
      <td>2</td>
      <td>philosophy</td>
    </tr>
    <tr>
      <td>3</td>
      <td>medicine</td>
    </tr>
    <tr>
      <td>4</td>
      <td>novel</td>
    </tr>
  </tbody>
</table>

<h3 id="选择数据">选择数据</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="sh">'</span><span class="s">test.db</span><span class="sh">'</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">c</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">SELECT name FROM category</span><span class="sh">'</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>science</td>
    </tr>
    <tr>
      <td>philosophy</td>
    </tr>
    <tr>
      <td>medicine</td>
    </tr>
    <tr>
      <td>novel</td>
    </tr>
  </tbody>
</table>

<h3 id="更新和删除数据">更新和删除数据</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="sh">'</span><span class="s">test.db</span><span class="sh">'</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>

<span class="n">c</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">UPDATE category SET name=? WHERE id=?;</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="sh">'</span><span class="s">metaphysics</span><span class="sh">'</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">c</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">DELETE FROM category WHERE id=4;</span><span class="sh">'</span><span class="p">)</span>
<span class="n">conn</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
<span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>science</td>
    </tr>
    <tr>
      <td>2</td>
      <td>philosophy</td>
    </tr>
    <tr>
      <td>3</td>
      <td>metaphysics</td>
    </tr>
  </tbody>
</table>

<h3 id="查看所有表和删除表">查看所有表和删除表</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="sh">'</span><span class="s">test.db</span><span class="sh">'</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>

<span class="n">tables</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">SELECT name FROM sqlite_master WHERE type=</span><span class="sh">"</span><span class="s">table</span><span class="sh">"</span><span class="s">;</span><span class="sh">'</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>

<span class="n">c</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">DROP TABLE category;</span><span class="sh">'</span><span class="p">)</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">SELECT name FROM sqlite_master WHERE type=</span><span class="sh">"</span><span class="s">table</span><span class="sh">"</span><span class="s">;</span><span class="sh">'</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>

<span class="n">conn</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
<span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>输出：</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[('category',)]
[]
</code></pre></div></div>

<h2 id="网络">网络</h2>

<p>想要深入了解 Python 服务器框架，例如 Django, Twisted, 和 web.py，你首先需要掌握它们的基石 - socket (套接字)。套接字提供了基于网络的进程间通信能力。掌握套接字可以帮助我们更有效地使用和设计框架。</p>

<p>所有的 Python 框架，从底层开始，都是基于套接字实现的。如果你能从底层的套接字开始，建立一个完整的 Python 服务器，并处理诸如 MVC (Model-View-Control)、多线程等复杂问题。</p>

<p>值得注意的是，套接字接口是由操作系统提供的，并不仅限于 Python。像 Apache 这样的服务器就是用 C 语言实现的，但框架的语言实现是不可以跨语言使用的。</p>

<h3 id="tcpip-和-socket">TCP/IP 和 socket</h3>

<p>在探讨套接字之前，我们需要先了解网络传输，尤其是 TCP/IP 协议。套接字是基于网络协议的进程间通信方法，有 TCP 和 UDP 两种类型，其中 TCP 最为常用。</p>

<p>TCP 套接字可以看作双向通道，两个进程可以通过它互相发送和接收信息，即使它们位于两台不同的计算机上。为了支持这种通信，我们需要一个协议 - TCP 协议，它规定了通信的各种规则。</p>

<p>每个套接字都包含四个地址信息：两个 IP 地址 (两台计算机的地址) 和两个端口号 (每个进程的标识)。</p>

<pre class="asciiart">
               IP 1
          ┌─┐┌──────┐┌────┐             
          │═││░░░░░░││port│◀─────────┐  
          │═││░░░░░░│└────┘          │  
          └─┘╧══════╧                ▼  
    IP 2                   IP 3   ┌────┐
┌─┐┌──────┐┌────┐      ┌─┐┌──────┐│port│
│═││░░░░░░││port│      │═││░░░░░░│├────┤
│═││░░░░░░│└────┘      │═││░░░░░░││port│
└─┘╧══════╧   │        └─┘╧══════╧└────┘
              │                      ▲  
              │                      │  
              └──────────────────────┘    
</pre>

<h3 id="socket-服务器">Socket 服务器</h3>

<p>在网络中，计算机可以作为服务器或客户端。服务器会开放特定的端口，等待其他计算机的连接。当其他计算机尝试连接时，服务器开始提供服务。</p>

<p>在 Python 中，我们可以使用 <code class="language-plaintext highlighter-rouge">socket</code> 模块来实现底层的套接字编程。服务器端使用 <code class="language-plaintext highlighter-rouge">bind()</code> 方法指定地址和端口，使用 <code class="language-plaintext highlighter-rouge">listen()</code> 方法监听连接。当客户端使用 <code class="language-plaintext highlighter-rouge">connect()</code> 连接时，服务器使用 <code class="language-plaintext highlighter-rouge">accept()</code> 接受连接。</p>

<p>以下是一个简单的服务器和客户端的代码示例：</p>

<p>服务器代码:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 文件: server.py
</span><span class="kn">import</span> <span class="n">socket</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>

<span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">server_socket</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="n">server_socket</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">client_conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server_socket</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">client_conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">the request of client is: </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s">, connected by: </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">client_conn</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Yes</span><span class="sh">'</span><span class="p">)</span>
<span class="n">client_conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<p>客户端代码:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 文件 client.py
</span><span class="kn">import</span> <span class="n">socket</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="sh">'</span><span class="s">127.0.0.1</span><span class="sh">'</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">request</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">can you hear me</span><span class="sh">'</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="n">reply</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">the reply is </span><span class="si">{</span><span class="n">reply</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<p>为了在同一台计算机上运行这个示例，你需要在两个<strong>不同的命令行窗口</strong>中分别运行服务器和客户端。</p>

<h3 id="http-服务器">HTTP 服务器</h3>

<p>当我们谈到网络连接，我们通常想到的是使用 TCP socket 连接两台计算机。但直接使用 socket 可能会导致一些安全和兼容性问题。为了解决这些问题，我们通常使用应用层的协议，如 HTTP 协议，来规定如何使用 socket。</p>

<p><strong>HTTP</strong> 是一个基于<strong>请求-响应</strong>模型的协议。这意味着客户端发送一个请求到服务器，服务器接收并处理这个请求，然后发送一个响应给客户端。</p>

<p>现在，让我们看一个简单的HTTP服务器的实现：</p>

<h4 id="示例">示例</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">socket</span>

<span class="c1"># 设置地址和端口
</span><span class="n">HOST</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>

<span class="c1"># 定义HTTP响应内容
</span><span class="n">text_content</span> <span class="o">=</span> <span class="sh">"""</span><span class="se">\
</span><span class="s">HTTP/1.1 200 OK
Content-Type: text/html

&lt;head&gt;
&lt;title&gt;Custom Python Server&lt;/title&gt;
&lt;/head&gt;

&lt;html&gt;
&lt;p&gt;Welcome to our Python Server!&lt;/p&gt;
&lt;img src=</span><span class="sh">"</span><span class="s">test.jpg</span><span class="sh">"</span><span class="s"> width=</span><span class="sh">"</span><span class="s">200px</span><span class="sh">"</span><span class="s">&gt;&lt;/img&gt;
&lt;br&gt;

&lt;form name=</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="s"> action=</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="s"> method=</span><span class="sh">"</span><span class="s">post</span><span class="sh">"</span><span class="s">&gt;
    Your Response: &lt;input type=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s"> name=</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="s">&gt;&lt;br&gt;
    &lt;input type=</span><span class="sh">"</span><span class="s">submit</span><span class="sh">"</span><span class="s"> value=</span><span class="sh">"</span><span class="s">Send!</span><span class="sh">"</span><span class="s">&gt;
&lt;/form&gt;

&lt;p&gt;Response received: {value}&lt;/p&gt;

&lt;/html&gt;
</span><span class="sh">"""</span>

<span class="c1"># 读取图片并设置为HTTP响应格式
</span><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">test.jpg</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pic_content</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">HTTP/1.1 200 OK</span><span class="se">\n</span><span class="sh">'</span><span class="o">+</span>\
                  <span class="sa">b</span><span class="sh">'</span><span class="s">Content-Type: image/jpeg</span><span class="se">\n\n</span><span class="sh">'</span>
    <span class="n">pic_content</span> <span class="o">+=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="c1"># 配置 socket
</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>

<span class="c1"># 服务器始终在线
</span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># 等待连接
</span>    <span class="n">s</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># 处理GET请求
</span>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span> <span class="o">==</span> <span class="sh">'</span><span class="s">/test.jpg</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">pic_content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sh">''</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Connected by: </span><span class="sh">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Request is: </span><span class="sh">"</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="c1"># 处理POST请求
</span>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="se">\r\n</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">form</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="sh">''</span><span class="p">)</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="n">idx</span><span class="p">:]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">=</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="c1"># 关闭连接
</span>    <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="使用-socketserver">使用 socketserver</h4>

<p>虽然上面的方法是有效的，但还有更简单的方法来创建一个HTTP服务器，这就是使用 Python 的 <code class="language-plaintext highlighter-rouge">socketserver</code> 库。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">socketserver</span>

<span class="c1"># 设置地址和端口
</span><span class="n">HOST</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>

<span class="c1"># 定义HTTP响应内容
</span><span class="n">text_content</span> <span class="o">=</span> <span class="sh">"""</span><span class="se">\
</span><span class="s">HTTP/1.1 200 OK
Content-Type: text/html

&lt;head&gt;
&lt;title&gt;Custom Python Server&lt;/title&gt;
&lt;/head&gt;

&lt;html&gt;
&lt;p&gt;Welcome to our Python Server!&lt;/p&gt;
&lt;img src=</span><span class="sh">"</span><span class="s">test.jpg</span><span class="sh">"</span><span class="s"> width=</span><span class="sh">"</span><span class="s">200px</span><span class="sh">"</span><span class="s">&gt;&lt;/img&gt;
&lt;br&gt;

&lt;form name=</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="s"> action=</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="s"> method=</span><span class="sh">"</span><span class="s">post</span><span class="sh">"</span><span class="s">&gt;
    Your Response: &lt;input type=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s"> name=</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="s">&gt;&lt;br&gt;
    &lt;input type=</span><span class="sh">"</span><span class="s">submit</span><span class="sh">"</span><span class="s"> value=</span><span class="sh">"</span><span class="s">Send!</span><span class="sh">"</span><span class="s">&gt;
&lt;/form&gt;

&lt;p&gt;Response received: {value}&lt;/p&gt;

&lt;/html&gt;
</span><span class="sh">"""</span>

<span class="c1"># 读取图片并设置为HTTP响应格式
</span><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">test.jpg</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pic_content</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">HTTP/1.1 200 OK</span><span class="se">\n</span><span class="sh">'</span><span class="o">+</span>\
                  <span class="sa">b</span><span class="sh">'</span><span class="s">Content-Type: image/jpeg</span><span class="se">\n\n</span><span class="sh">'</span>
    <span class="n">pic_content</span> <span class="o">+=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MyTCPHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="p">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="c1"># 定义如何处理每个连接
</span>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Connected by</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">client_address</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Request is:</span><span class="sh">"</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="sh">'</span><span class="s">/test.jpg</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">pic_content</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="se">\r\n</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">form</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="sh">''</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="n">idx</span><span class="p">:]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">=</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="c1"># 开始服务器
</span><span class="k">with</span> <span class="n">socketserver</span><span class="p">.</span><span class="nc">TCPServer</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">MyTCPHandler</span><span class="p">)</span> <span class="k">as</span> <span class="n">server</span><span class="p">:</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">serve_forever</span><span class="p">()</span>
</code></pre></div></div>

<p>使用 <code class="language-plaintext highlighter-rouge">socketserver</code> 的好处是它简化了大部分 socket 编程的复杂性。这让我们更容易理解和维护代码。</p>

<h3 id="httpserver">http.server</h3>

<h4 id="simplehttprequesthandler">SimpleHTTPRequestHandler</h4>

<p>HTTP 协议基于 TCP 协议，但增加了更多的规范。这些规范，虽然限制了 TCP 协议的功能，但大大提高了信息封装和提取的方便程度。</p>

<p>对于一个 HTTP 请求 (request) 来说，它包含有两个重要信息：</p>

<ol>
  <li>请求方法</li>
  <li>URL。</li>
</ol>

<p>例子，刚才的 server 分析：</p>

<table>
  <thead>
    <tr>
      <th>请求方法</th>
      <th>URL</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>GET</td>
      <td>/</td>
      <td>发送 text_content</td>
    </tr>
    <tr>
      <td>GET</td>
      <td>/text.png</td>
      <td>发送 pic_content</td>
    </tr>
    <tr>
      <td>POST</td>
      <td>/</td>
      <td>分析 request 主体中包含的 value</td>
    </tr>
  </tbody>
</table>

<p>根据请求方法和URL的不同，一个大型的 HTTP 服务器可以应付成千上万种不同的请求。在 Python 中，我们可以使用 http.server 包来规定针对不同请求的操作。其中，SimpleHTTPServer 可以用于处理 GET 方法和 HEAD 方法的请求。它读取 request 中的 URL 地址，找到对应的静态文件，分析文件类型，用 HTTP 协议将文件发送给客户。</p>

<p>我在当前目录下生成 index.html 文件:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>WOW<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;p&gt;</span>Wow, Python Server<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;IMG</span> <span class="na">src=</span><span class="s">"test.jpg"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;form</span> <span class="na">name=</span><span class="s">"input"</span> <span class="na">action=</span><span class="s">"/"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
First name:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"firstname"</span><span class="nt">&gt;&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>使用 http.server 中的类 SimpleHTTPRequestHandler 写服务器：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">socketserver</span>
<span class="kn">import</span> <span class="n">http.server</span> <span class="k">as</span> <span class="n">http_server</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>

<span class="c1"># Create the server
</span><span class="n">handler</span> <span class="o">=</span> <span class="n">http_server</span><span class="p">.</span><span class="n">SimpleHTTPRequestHandler</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">socketserver</span><span class="p">.</span><span class="nc">TCPServer</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">handler</span><span class="p">)</span>
<span class="c1"># Start the server
</span><span class="n">server</span><span class="p">.</span><span class="nf">serve_forever</span><span class="p">()</span>
</code></pre></div></div>
<p>运行结果与之前的一样。</p>

<h4 id="cgihttpserver">CGIHTTPServer</h4>

<p>CGIHTTPRequestHandler 类继承自 SimpleHTTPRequestHandler 类，所以可以用来代替上面的例子，来提供静态文件的服务。此外，CGIHTTPRequestHandler类还可以用来运行CGI脚本。</p>

<p>先看看什么是 CGI (Common Gateway Interface)。CGI 是服务器和应用脚本之间的一套接口标准。它的功能是让服务器程序运行脚本程序，将程序的输出作为 response 发送给客户。总体的效果，是<strong>允许服务器动态的生成回复内容，而不必局限于静态文件</strong>。</p>

<p>支持 CGI 的服务器程接收到客户的请求，根据请求中的 URL，运行对应的脚本文件。服务器会将 HTTP 请求的信息和 socket 信息传递给脚本文件，并等待脚本的输出。脚本的输出封装成合法的 HTTP 回复，发送给客户。CGI可以充分发挥服务器的可编程性，让服务器变得“更聪明”。</p>

<p>服务器和 CGI 脚本之间的通信要符合 CGI 标准。CGI 的实现方式有很多，比如说使用 Apache 服务器与 Perl 写的CGI脚本，或者 Python 服务器与 shell 写的CGI脚本。</p>

<p>为了使用 CGI，我们需要使用 http.server 包中的 HTTPServer 类来构建服务器。Python服务器的改动很简单。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">http.server</span>
<span class="kn">from</span> <span class="n">http.server</span> <span class="kn">import</span> <span class="n">BaseHTTPRequestHandler</span>
<span class="kn">from</span> <span class="n">http.server</span> <span class="kn">import</span> <span class="n">CGIHTTPRequestHandler</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>

<span class="c1"># Create the server
</span><span class="n">handler</span> <span class="o">=</span> <span class="n">BaseHTTPRequestHandler</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="nc">HTTPServer</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">handler</span><span class="p">)</span>
<span class="n">server</span><span class="p">.</span><span class="nf">serve_forever</span><span class="p">()</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">CGIHTTPRequestHandler</code> 默认当前目录下的 cgi-bin 和 ht-bin 文件夹中的文件为 CGI 脚本，而存放于其他地方的文件被认为是静态文件。因此，我们需要修改一下 index.html，将其中 <code class="language-plaintext highlighter-rouge">form</code> 元素指向的 <code class="language-plaintext highlighter-rouge">action</code> 改为 <code class="language-plaintext highlighter-rouge">cgi-bin/post.py</code>。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;head&gt;
&lt;title&gt;WOW&lt;/title&gt;
&lt;/head&gt;
&lt;html&gt;
&lt;p&gt;Wow, Python Server&lt;/p&gt;
&lt;IMG src="test.jpg"/&gt;
&lt;form name="input" action="cgi-bin/post.py" method="post"&gt;
First name:&lt;input type="text" name="firstname"&gt;&lt;br&gt;
&lt;input type="submit" value="Submit"&gt;
&lt;/form&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>我创建一个cgi-bin的文件夹，并在cgi-bin中放入如下post.py文件，也就是我们的CGI脚本：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3  # 这一行是必要的，指定脚本的解释器
</span><span class="kn">import</span> <span class="n">cgi</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="p">.</span><span class="nc">FieldStorage</span><span class="p">()</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Content-Type: text/html</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">()</span>  <span class="c1"># 这个空行是必要的，作为首部的终止
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;p&gt;Hello world!&lt;/p&gt;</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;p&gt;</span><span class="sh">"</span> <span class="o">+</span> <span class="nf">repr</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">firstname</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="sh">"</span><span class="s">&lt;/p&gt;</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>(post.py需要有执行权限，chmod +x cgi-bin/post.py)</p>

<p>第一行说明了脚本所使用的语言，即 Python。 cgi 包用于提取请求中包含的表格信息。脚本只负责将所有的结果输出到标准输出 (使用print)。<code class="language-plaintext highlighter-rouge">CGIHTTPRequestHandler</code> 会收集这些输出，封装成 HTTP 回复，传送给客户端。</p>

<p>对于 POST 方法的请求，它的 URL 需要指向一个 CGI 脚本 (也就是在 cgi-bin 或者 ht-bin 中的文件)。<code class="language-plaintext highlighter-rouge">CGIHTTPRequestHandler</code> 继承自 <code class="language-plaintext highlighter-rouge">SimpleHTTPRequestHandler</code>，所以也可以处理 GET 方法和 HEAD 方法的请求。如果 URL 指向CGI脚本时，服务器将脚本的运行结果传送到客户端；当此时URL 指向静态文件时，服务器将文件的内容传送到客户端。</p>

</div>


    </div>

  </body>

</html>
